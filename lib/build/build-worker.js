// Generated by CoffeeScript 1.6.3
/*
Build worker process main script.
*/

var BuildWorker, CompileCoffeeScript, CompileStylus, CopyFile, Fake, worker, _;

_ = require('underscore');

CompileCoffeeScript = require('./task/CompileCoffeeScript');

CompileStylus = require('./task/CompileStylus');

Fake = require('./task/Fake');

CopyFile = require('./task/CopyFile');

BuildWorker = (function() {
  BuildWorker.prototype.tasks = null;

  function BuildWorker() {
    this.tasks = {};
  }

  BuildWorker.prototype.addTask = function(taskParams) {
    /*
    Registers and launches new task based on the given params
    @param Object taskParams
    @return Future[Nothing]
    */

    var TaskClass, task,
      _this = this;
    TaskClass = this._chooseTask(taskParams);
    task = this.tasks[taskParams.id] = new TaskClass(taskParams);
    task.run();
    return task.ready().andThen(function() {
      return delete _this.tasks[taskParams.id];
    });
  };

  BuildWorker.prototype._chooseTask = function(taskParams) {
    /*
    Selects task class by task params
    @return Class
    */

    switch (taskParams.info.ext) {
      case '.coffee':
        return CompileCoffeeScript;
      case '.styl':
        return CompileStylus;
      case '.js':
        return CopyFile;
      default:
        return Fake;
    }
  };

  return BuildWorker;

})();

worker = new BuildWorker;

process.on('message', function(task) {
  return worker.addTask(task).done(function() {
    return process.send({
      type: 'completed',
      task: task.id
    });
  });
});
